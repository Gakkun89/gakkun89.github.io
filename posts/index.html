<!doctype html><html lang=en><head><title>Posts :: Gakked</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/pink.css><link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/img/favicon/pink.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:url" content="/posts/"><meta property="og:site_name" content="Gakked"><meta property="og:image" content="/img/favicon/pink.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><link href=/posts/index.xml rel=alternate type=application/rss+xml title=Gakked></head><body class=pink><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Gakked</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=https://github.com/Gakkun89/>GitHub</a></li><li><a href=https://www.linkedin.com/in/mike-warren/>LinkedIn</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=https://github.com/Gakkun89/>GitHub</a></li><li><a href=https://www.linkedin.com/in/mike-warren/>LinkedIn</a></li></ul></nav></header><div class=content><div class=posts><div class="post on-list"><h1 class=post-title><a href=/posts/tricky-associations/>Dude where&rsquo;s my association?</a></h1><div class=post-meta><span class=post-date>2022-06-09</span></div><span class=post-tags>#<a href=/tags/activerecord/>ActiveRecord</a>&nbsp;
#<a href=/tags/associations/>Associations</a>&nbsp;</span><div class=post-content><p>I ran into an issue I had never faced recently when validating changes made to associated models.</p><h3 id=context>Context:</h3><p>Let&rsquo;s suppose we have the following models (non-related info removed):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ApplicationRecord</span>
</span></span><span style=display:flex><span>  has_many <span style=color:#e6db74>:rules</span>
</span></span><span style=display:flex><span>  has_many <span style=color:#e6db74>:activities</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Rule</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ApplicationRecord</span>
</span></span><span style=display:flex><span>  belongs_to <span style=color:#e6db74>:user</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check!</span>(activity)
</span></span><span style=display:flex><span>    <span style=color:#75715e>#PSEUDO CODE</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unless</span> allowed_actions<span style=color:#f92672>.</span>include?(activity<span style=color:#f92672>.</span>action) <span style=color:#f92672>&amp;&amp;</span> allowed_tags<span style=color:#f92672>.</span>include?(activity<span style=color:#f92672>.</span>tags)
</span></span><span style=display:flex><span>      activity<span style=color:#f92672>.</span>add_error(<span style=color:#e6db74>&#34;Not allowed to do this activity&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Activity</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ApplicationRecord</span>
</span></span><span style=display:flex><span>   belongs_to <span style=color:#e6db74>:user</span>
</span></span><span style=display:flex><span>   has_and_belongs_to_many <span style=color:#e6db74>:tags</span>
</span></span><span style=display:flex><span>   validates_with <span style=color:#66d9ef>ActivityValidator</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Tag</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ApplicationRecord</span>
</span></span><span style=display:flex><span>   has_and_belongs_to_many <span style=color:#e6db74>:activities</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e># Tags contain information regarding the activity and rules can &#39;invalidate&#39; an activity based on certain tags</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e># E.g Rule does not allow User X to do any activities tagged with &#39;dangerous&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActivityValidator</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveModel</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Validator</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>IGNORED_ATTRIBUTES</span> <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;status&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>validate</span>(activity)
</span></span><span style=display:flex><span>    <span style=color:#75715e># Allow certain changes without validating rules again</span>
</span></span><span style=display:flex><span>    no_changes_present   <span style=color:#f92672>=</span> (activity<span style=color:#f92672>.</span>changed_attributes<span style=color:#f92672>.</span>keys <span style=color:#f92672>-</span> <span style=color:#66d9ef>IGNORED_ATTRIBUTES</span>)<span style=color:#f92672>.</span>empty? 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>if</span> no_changes_present
</span></span><span style=display:flex><span>    activity<span style=color:#f92672>.</span>user<span style=color:#f92672>.</span>rules<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>rule<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>      rule<span style=color:#f92672>.</span>check!(activity)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h3 id=issue>Issue</h3><p>Maybe the more seasoned Rails devs have already noticed the problem.</p><p>The issue I faced was that when changing any of the attributes on the activity (excluding the ignored <code>status</code>) the <code>Rule</code> was correctly evaluated. However, if there was a <code>Rule</code> which was based on checking <code>Tag</code>s when making any changes to just the associated tags the validator passed even with &lsquo;invalid&rsquo; <code>Tag</code>s.</p><p>What was going on? Why aren&rsquo;t my associations being validated?</p><p>First port of call was to slap in a <code>binding.pry</code> to see what <code>no_changes_present</code> and to my suprise it was returning <code>true</code> even when I was either deleting or adding <code>Tag</code>s.</p><p>It was at this point I found out that <code>activity.changed_attributes</code> (and by extension <code>#changes</code>) ONLY covers changes to that model&rsquo;s direct attributes and does not include changes to any associated models. <a href=https://api.rubyonrails.org/classes/ActiveModel/Dirty.html#method-i-changed_attributes>Docs for <code>changed_attributes</code></a></p><p>Yea I know a real &lsquo;duh&rsquo; moment (the clue is in the name of the method) but due to less than perfect tests (which I will write more on in another post) this went unnoticed for too long.</p><h3 id=solution>Solution</h3><p>The solution I chose is pretty simple, add the following to the <code>no_changes_present</code> check.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>activity<span style=color:#f92672>.</span>tags<span style=color:#f92672>.</span>any? { <span style=color:#f92672>|</span>tag<span style=color:#f92672>|</span> tag<span style=color:#f92672>.</span>marked_for_destruction? <span style=color:#f92672>||</span> tag<span style=color:#f92672>.</span>new_record? }
</span></span></code></pre></div><p>Now if a <code>Tag</code> is added (<code>new_record?</code>) or removed (<code>marked_for_destruction?</code>) <code>no_changes_present</code> will now be <code>false</code> and the validation will be carried out as normal.</p><p>One gotcha to remember is that we need to do a similar thing for the <code>check!</code> method on the <code>Rule</code>. However this time we only want to validate against <code>Tag</code>s that are already associated or newly associated so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check!</span>(activity)
</span></span><span style=display:flex><span>  <span style=color:#75715e>#PSEUDO CODE</span>
</span></span><span style=display:flex><span>  active_tags <span style=color:#f92672>=</span> activity<span style=color:#f92672>.</span>tags<span style=color:#f92672>.</span>reject { <span style=color:#f92672>|</span> tag <span style=color:#f92672>|</span> tag<span style=color:#f92672>.</span>marked_for_destruction? }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unless</span> allowed_actions<span style=color:#f92672>.</span>include?(activity<span style=color:#f92672>.</span>action) <span style=color:#f92672>&amp;&amp;</span> allowed_tags<span style=color:#f92672>.</span>include?(active_tags)
</span></span><span style=display:flex><span>    activity<span style=color:#f92672>.</span>add_error(<span style=color:#e6db74>&#34;Not allowed to do this activity&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>This way we can remove the due to be deleted tags to give us a correct validation before saving the edited <code>Activity</code>.</p><p>Now I am aware there are probably a million ways I could&rsquo;ve achieved the same result so I would love to hear from anyone out there who has any suggestions on how else this could be implemented.</p><p>Til next time..</p></div></div><div class="post on-list"><h1 class=post-title><a href=/posts/presence-in-rails/>Presence in Rails</a></h1><div class=post-meta><span class=post-date>2022-05-29</span></div><span class=post-tags>#<a href=/tags/presence/>presence</a>&nbsp;
#<a href=/tags/rails/>Rails</a>&nbsp;
#<a href=/tags/ruby/>Ruby</a>&nbsp;</span><div class=post-content><p>Some of the most common methods I use on a daily basis when writing <code>if/else</code>&rsquo;s and <a href=https://devblast.com/b/what-are-guard-clauses>guard clauses</a> are &lsquo;presence checkers&rsquo;.
It can be really helpful to know if the <code>Array</code>, <code>String</code>, <code>object</code> etc. has is not just &rsquo;empty&rsquo;/<code>[]</code>/<code>false</code>/<code>nil</code>as your existing logic may fail if passed such data. However Ruby (and Rails) have a number of methods to achieve this and as a junior dev I often found myself checking which to use in each specific scenario.</p><h2 id=nil-blank-empty-which-one-to-use><code>nil?</code> <code>blank?</code> <code>empty?</code> which one to use?</h2><p>The methods I come back to the most are <code>blank?</code> and <code>present?</code> (which is actualy just an alias for <code>!blank?</code>) because they offer an extra layer of safety in their return:</p><table><thead><tr><th></th><th>blank?</th><th>present?</th></tr></thead><tbody><tr><td>nil</td><td>true</td><td><code>false</code></td></tr><tr><td>false</td><td>true</td><td><code>false</code></td></tr><tr><td>true</td><td><code>false</code></td><td>true</td></tr><tr><td>0</td><td><code>false</code></td><td>true</td></tr><tr><td>1</td><td><code>false</code></td><td>true</td></tr><tr><td>""</td><td>true</td><td><code>false</code></td></tr><tr><td>" "</td><td>true</td><td><code>false</code></td></tr><tr><td>[]</td><td>true</td><td><code>false</code></td></tr><tr><td>[nil]</td><td><code>false</code></td><td>true</td></tr><tr><td>{}</td><td>true</td><td><code>false</code></td></tr><tr><td>{a: nil}</td><td><code>false</code></td><td>true</td></tr></tbody></table><p>Either way you are guarenteed a <code>true</code> or <code>false</code> response and can build your logic around that boolean.
Other methods are more restrictive:</p><ul><li><p><code>nil?</code> will only return <code>true</code> when passed <code>nil</code> any other value results in <code>false</code> which restricts its usefulness to certain situations.</p></li><li><p><code>empty?</code> can only be used on <code>Enumerables</code> that is <code>Hash</code>&rsquo;s (<code>{}</code>) and <code>Array</code>&rsquo;s (<code>[]</code>) and <code>String</code>&rsquo;s (<code>" "</code>), trying to use it on an <code>Integer</code> will result in:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>.</span>empty?
</span></span><span style=display:flex><span><span style=color:#e6db74>NoMethodError</span>: undefined method <span style=color:#e6db74>`empty?&#39; for 0:Integer
</span></span></span></code></pre></div><ul><li><p>There is even <code>zero?</code> which is restricted to just <code>Integers</code> and responds <code>true</code> on 0 and <code>false</code> on any other number.</p></li><li><p>Rails, more specifically <code>ActiveRecord</code> offers <code>exists?</code> which when used against an <code>ActiveModel::Model</code> can be used for checking the DB for the existance of a model that matches the parameters passed:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># For a given model of &#39;Dog&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Dog</span><span style=color:#f92672>.</span>exists?(<span style=color:#ae81ff>5</span>) <span style=color:#75715e># Checks for the ID of the model in the DB</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Dog</span><span style=color:#f92672>.</span>exists?(<span style=color:#e6db74>&#39;5&#39;</span>) <span style=color:#75715e># See above</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Dog</span><span style=color:#f92672>.</span>exists?(<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;name LIKE ?&#39;</span>, <span style=color:#e6db74>&#34;%</span><span style=color:#e6db74>#{</span>query<span style=color:#e6db74>}</span><span style=color:#e6db74>%&#34;</span><span style=color:#f92672>]</span>) <span style=color:#75715e># Specify other attributes to query for</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Dog</span><span style=color:#f92672>.</span>exists?(name: <span style=color:#e6db74>&#39;Good Boy&#39;</span>) <span style=color:#75715e># See above</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Dog</span><span style=color:#f92672>.</span>exists?(id: <span style=color:#f92672>[</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>8</span><span style=color:#f92672>]</span>) <span style=color:#75715e># Check multiple IDs at once</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Dog</span><span style=color:#f92672>.</span>exists?(<span style=color:#66d9ef>false</span>) <span style=color:#75715e># Return False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Dog</span><span style=color:#f92672>.</span>exists? <span style=color:#75715e># Checks if there are any instances of Dog in the DB</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Dog</span><span style=color:#f92672>.</span>where(name: <span style=color:#e6db74>&#39;Skye&#39;</span>, <span style=color:#e6db74>good_boy</span>: <span style=color:#66d9ef>true</span>)<span style=color:#f92672>.</span>exists? <span style=color:#75715e># More specific querying is possible</span>
</span></span></code></pre></div><p><a href=https://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F>Further reading on <code>exists?</code></a></p><h1 id=performance-and-presence-checking>Performance and presence checking</h1><p>Unless you are Twitter scale it doesn&rsquo;t matter.</p><p>Of course there are differences between using the different methods against different data types (<a href=https://stackoverflow.com/a/20814251/8459243>as can be seen here in this comprehensive SO answer</a>). However for most projects these presence checks will not be a performance bottle neck.</p><p>For example my favoured <code>blank?</code> is actually 2x slower than using <code>empty?</code>, this can easily be seen by looking at the <a href=https://github.com/rails/rails/blob/e2efc667dea886e71c33e3837048e34b7a1fe470/activesupport/lib/active_support/core_ext/object/blank.rb#L18>source code</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>blank?</span>
</span></span><span style=display:flex><span>  respond_to?(<span style=color:#e6db74>:empty?</span>) ? <span style=color:#f92672>!!</span>empty? : <span style=color:#f92672>!</span>self
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>However in most projects this performance hit will not be noticable.</p><p>One caveat to the above statement is when dealing with <code>ActiveRecord</code> checks which hit the DB. The topic of performance in those queries is quite involved and is expertly handled in <a href=https://www.ombulabs.com/blog/benchmark/performance/rails/present-vs-any-vs-exists.html>this post</a> which I would encourage anyone interested to read.</p><p><code>Thats all folks</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>LinkedIn</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Messenger</span><span style=color:#f92672>.</span>send(<span style=color:#e6db74>`Mike Warren`</span>)  <span style=color:#66d9ef>if</span> questions<span style=color:#f92672>.</span>present?
</span></span></code></pre></div></div></div><div class="post on-list"><h1 class=post-title><a href=/posts/hello-world/>Hello World</a></h1><div class=post-meta><span class=post-date>2022-05-26</span></div><span class=post-tags>#<a href=/tags/introduction/>introduction</a>&nbsp;
#<a href=/tags/til/>TIL</a>&nbsp;</span><div class=post-content><p>Starting off with one of the most over-used tropes in programming to introduce another, a tech/random thoughts/brain dump blog.</p><h3 id=what-this-blog-is>What this blog is:</h3><ul><li>A place for me to write breakdowns of new topics that I encounter while working as a back-end Ruby on Rails dev</li><li>An opportunity to improve my understanding of CS related topics via writing hopefully useful guides/ TIL (Today I learned) style posts</li><li>A distraction from the bug tickets I am supposed to be fixing…</li></ul><h3 id=what-this-blog-isnt>What this blog isn&rsquo;t:</h3><ul><li>A comprehensive source of knowledge on any topics posted</li><li>The &lsquo;right&rsquo; way to do things</li><li>Interesting (I don&rsquo;t expect anyone to read this but if one person can be helped by anything written here then that would be great)</li></ul><p>Hopefully I can share a few useful things on here and if anyone wants to get in contant please see my GH and LinkedIn linked above.</p><p>Cheers!</p></div></div><div class=pagination><div class=pagination__buttons></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script></div></body></html>